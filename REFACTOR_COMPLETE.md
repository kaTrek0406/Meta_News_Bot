# ‚úÖ –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ - –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞

## üìã –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. ‚úÖ config.json
- –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `region` –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (EU, MD, GLOBAL)
- –î–æ–±–∞–≤–ª–µ–Ω –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `lang` –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Accept-Language
- –î–æ–±–∞–≤–ª–µ–Ω –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `proxy_country` –¥–ª—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã –ø—Ä–æ–∫—Å–∏
- –ü—Ä–∏–º–µ—Ä: `{ "url": "...", "tag": "news_policy", "region": "EU", "lang": "en-GB", "proxy_country": "de" }`

### 2. ‚úÖ src/config.py
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
  ```python
  PROXY_URL: str  # –ü–æ–ª–Ω—ã–π URL –ø—Ä–æ–∫—Å–∏ (MD)
  PROXY_URL_EU: str  # Fallback –ø—Ä–æ–∫—Å–∏ –¥–ª—è EU
  USE_PROXY: bool
  PROXY_PROVIDER: str  # "froxy" –∏–ª–∏ –¥—Ä—É–≥–æ–π
  PROXY_STICKY: bool  # Sticky sessions
  PROXY_FALLBACK_EU: bool  # Fallback MD‚ÜíEU
  ```
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è:
  - `ensure_telegram_token()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞
  - `validate_proxy_config()` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–∫—Å–∏
  - `log_config_summary()` - –±–µ–∑–æ–ø–∞—Å–Ω–æ –ª–æ–≥–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤

### 3. ‚úÖ src/pipeline.py
**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

- **–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è** `_get_proxy_for_region(region, proxy_country, session_id)`:
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø—Ä–æ–∫—Å–∏ URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–≥–∏–æ–Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Froxy sticky-sessions —á–µ—Ä–µ–∑ `session=<rand>` –≤ –ø–∞—Ä–æ–ª–µ
  - –î–ª—è MD –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PROXY_URL`, –¥–ª—è EU - `PROXY_URL_EU`

- **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è** `_get_random_headers(url, accept_lang)`:
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π `Accept-Language` –∑–∞–≥–æ–ª–æ–≤–æ–∫
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —è–∑—ã–∫–∏

- **–ò–∑–º–µ–Ω–µ–Ω –∫–ª—é—á –∫—ç—à–∞**: `(tag, url, region)` –≤–º–µ—Å—Ç–æ `(tag, url)`
  - –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤

- **–î–æ–±–∞–≤–ª–µ–Ω Fallback MD‚ÜíEU**:
  ```python
  # –ü—Ä–∏ 407/403 —Å MD –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ EU –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  if status in (407, 403) and region == "MD" and PROXY_FALLBACK_EU:
      proxies = _get_proxy_for_region("EU", proxy_country, session_id)
      used_fallback = True
  ```

- **–ö–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–∑–¥–∞–µ—Ç —Å–≤–æ–π HTTP-–∫–ª–∏–µ–Ω—Ç** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—Ä–æ–∫—Å–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
- **–î–æ–±–∞–≤–ª–µ–Ω `region` –≤ item** –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –∫—ç—à
- **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `PRUNE_REMOVED_SOURCES`** –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º –∫—ç—à–∞

### 4. ‚úÖ src/storage.py
- **Auto-migration –Ω–∞ –ª–µ—Ç—É**: –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫—ç—à–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç `region='GLOBAL'` –∫ –∑–∞–ø–∏—Å—è–º –±–µ–∑ region
  ```python
  # –í load_cache()
  for item in data["items"]:
      if "region" not in item:
          item["region"] = "GLOBAL"
  ```

### 5. ‚úÖ scripts/migrate_region_tag.py
- –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –µ–¥–∏–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –∫—ç—à–∞
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
  - `data/cache/cache.json`
  - `data/items.json` (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –í—ã–≤–æ–¥–∏—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –æ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 6. ‚úÖ src/smart_formatter.py
- –î–æ–±–∞–≤–ª–µ–Ω —Å–ª–æ–≤–∞—Ä—å `REGION_BADGES` —Å —ç–º–æ–¥–∑–∏ —Ñ–ª–∞–≥–æ–≤:
  ```python
  REGION_BADGES = {
      "EU": "üá™üá∫ [EU]",
      "MD": "üá≤üá© [MD]",
      "GLOBAL": "üåç [GLOBAL]",
  }
  ```
- –û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `_format_api_change` –∏ `_format_policy_change`:
  - –ò–∑–≤–ª–µ–∫–∞—é—Ç `region` –∏–∑ detail
  - –î–æ–±–∞–≤–ª—è—é—Ç —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π badge –∫ –∑–∞–≥–æ–ª–æ–≤–∫—É

## üîß –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ–¥–µ–ª–∞—Ç—å (–ø–æ –∂–µ–ª–∞–Ω–∏—é)

### src/telegram_notify.py
–î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ (—Å–º. `REGION_REFACTOR_TODO.md`):
```python
def group_by_region(details: list) -> dict:
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è: EU ‚Üí MD ‚Üí GLOBAL
    ...
```

### src/tg/handlers.py
–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫–æ–º–∞–Ω–¥—É `/status`:
```python
# –í—ã–≤–æ–¥–∏—Ç—å:
# üá™üá∫ EU ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: 2, –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ 24—á: 5
# üá≤üá© MD ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: 0, –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ 24—á: 0
# üåç GLOBAL ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: 25, –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞ 24—á: 12
```

## üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env.template` –∏ `.env`:

```ini
# –ü—Ä–æ–∫—Å–∏ (Froxy)
USE_PROXY=1
PROXY_URL=http://wifi;md;;:YOUR_PASSWORD@proxy.froxy.com:9000
PROXY_URL_EU=http://wifi;de;;:YOUR_PASSWORD@proxy.froxy.com:9000
PROXY_PROVIDER=froxy
PROXY_STICKY=1
PROXY_FALLBACK_EU=1
```

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é

1. **–û–±–Ω–æ–≤–∏—Ç—å .env**:
   ```bash
   # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ –≤—ã—à–µ
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é** (–µ–¥–∏–Ω–æ–∂–¥—ã):
   ```bash
   python scripts/migrate_region_tag.py
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å config.json**:
   - –í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å `region`
   - –î–ª—è EU-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `region: "EU"`
   - –î–ª—è MD - `region: "MD"`
   - –û—Å—Ç–∞–ª—å–Ω—ã–µ - `region: "GLOBAL"`

4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞**:
   ```bash
   python -m src.main
   ```

5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏**:
   - –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞: `üîê –ü—Ä–æ–∫—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: –ø—Ä–æ–≤–∞–π–¥–µ—Ä=froxy, sticky=True, fallback_EU=True`
   - –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–æ —á–µ—Ä–µ–∑ EU fallback` (–µ—Å–ª–∏ –±—ã–ª 407/403 —Å MD)

## üéØ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**:
   - EU –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ EU –ø—Ä–æ–∫—Å–∏
   - MD –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ MD –ø—Ä–æ–∫—Å–∏
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π fallback MD‚ÜíEU –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

2. **Sticky-—Å–µ—Å—Å–∏–∏**:
   - –û–¥–∏–Ω IP –¥–ª—è –≤—Å–µ–≥–æ —Ä–∞—É–Ω–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (–µ—Å–ª–∏ `PROXY_STICKY=1`)
   - –ú–µ–Ω—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫

3. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ Accept-Language –∑–∞–≥–æ–ª–æ–≤–∫–∏**:
   - EU –∏—Å—Ç–æ—á–Ω–∏–∫–∏: `en-GB,en;q=0.9`
   - MD –∏—Å—Ç–æ—á–Ω–∏–∫–∏: `en-GB,en;q=0.9,ro;q=0.8,ru;q=0.7`
   - GLOBAL: `en-US,en;q=0.9`

4. **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã**:
   - –ö–∞–∂–¥–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–º–µ—á–µ–Ω–æ —Ñ–ª–∞–≥–æ–º —Ä–µ–≥–∏–æ–Ω–∞: üá™üá∫ [EU] / üá≤üá© [MD] / üåç [GLOBAL]

5. **Back-compatibility**:
   - –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç `region='GLOBAL'`
   - –ö–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫—ç—à–µ–º

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `REGION_REFACTOR_TODO.md` - –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –¥–ª—è telegram_notify.py –∏ handlers.py

## ‚ú® –ò—Ç–æ–≥

–í—ã–ø–æ–ª–Ω–µ–Ω–æ ~85% —Ä–∞–±–æ—Ç—ã. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞:
- ‚úÖ –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∫—Å–∏
- ‚úÖ Froxy sticky-sessions
- ‚úÖ Fallback MD‚ÜíEU
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ Accept-Language
- ‚úÖ –†–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–µ badges
- ‚úÖ Back-compatibility
- ‚úÖ –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ Telegram, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ /status) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è.
